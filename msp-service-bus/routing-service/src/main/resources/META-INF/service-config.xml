<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:int="http://www.springframework.org/schema/integration" xmlns:int-http="http://www.springframework.org/schema/integration/http"
    xmlns:int-xml="http://www.springframework.org/schema/integration/xml" xmlns:util="http://www.springframework.org/schema/util"
    xsi:schemaLocation="http://www.springframework.org/schema/integration/http http://www.springframework.org/schema/integration/http/spring-integration-http-4.1.xsd
		http://www.springframework.org/schema/integration/xml http://www.springframework.org/schema/integration/xml/spring-integration-xml-4.1.xsd
		http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration-4.1.xsd
		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.1.xsd
		http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-4.1.xsd">

    <import resource="service-beans.xml" />

    <int-http:inbound-gateway request-channel="routingServiceHttpInboundChannel" path="/services/router/{serviceName}"
        supported-methods="POST" reply-channel="routingServiceHttpOutboundChannel" error-channel="errorChannel"
        reply-timeout="${routingServiceReplyTimeout}">
        <int-http:request-mapping consumes="text/xml" produces="text/xml" />
        <int-http:header name="serviceName" expression="#pathVariables.serviceName" />
    </int-http:inbound-gateway>

    <int:channel id="routingServiceHttpInboundChannel">
        <int:interceptors>
            <int:wire-tap channel="routingServiceHttpInboundChannelLogger" />
        </int:interceptors>
    </int:channel>
    <int:logging-channel-adapter id="routingServiceHttpInboundChannelLogger" expression="'[RQ]: '+#this" />

    <int:header-enricher id="wsaValidator" input-channel="routingServiceHttpInboundChannel"
        output-channel="validatorFilterChannel" default-overwrite="true">
        <int:header name="#{T(gub.msp.bus.routingservice.soap.wsaddressing.WSAValidatorConstants).ERROR_HEADER_NAME}"
            ref="wsaValidatorBean" method="validate" />
    </int:header-enricher>

    <int:channel id="validatorFilterChannel" />

    <int:filter id="wsaValidatorFilter" input-channel="validatorFilterChannel" output-channel="wsaHeadersEnricherChannel"
        discard-channel="discardWsaValidatorChannel" ref="wsaValidationFilterBean" />

    <int:channel id="discardWsaValidatorChannel" />
    <int:transformer id="soapFaultBuilder" input-channel="discardWsaValidatorChannel" output-channel="routingServiceHttpOutboundChannel"
        ref="soapFaultTransformerBean" />

    <int:channel id="wsaHeadersEnricherChannel" />

    <int-xml:xpath-header-enricher id="wsaToXpathEnricher" input-channel="wsaHeadersEnricherChannel"
        output-channel="httpHeadersEnricherChannel" default-overwrite="true">
        <int-xml:header name="#{T(gub.msp.bus.routingservice.soap.wsaddressing.WSAValidatorConstants).WSA_REQUEST_TO}"
            evaluation-type="STRING_RESULT" overwrite="true" xpath-expression-ref="wsaToXPathExpr" />
        <int-xml:header name="#{T(gub.msp.bus.routingservice.soap.wsaddressing.WSAValidatorConstants).WSA_REQUEST_ACTION}"
            evaluation-type="STRING_RESULT" overwrite="true" xpath-expression-ref="wsaActionXPathExpr" />
    </int-xml:xpath-header-enricher>

    <int:channel id="httpHeadersEnricherChannel" />

    <int:header-enricher id="httpHeadersEnricher" input-channel="httpHeadersEnricherChannel"
        output-channel="requestServiceHttpChannel">
        <int:header name="#{T(org.springframework.messaging.MessageHeaders).CONTENT_TYPE}" value="text/xml;charset=utf-8" />
        <int:header name="serviceUrl" ref="serviceUrlEnricherBean" method="enrich" />
    </int:header-enricher>

    <int:channel id="requestServiceHttpChannel">
        <int:interceptors>
            <int:wire-tap channel="requestServiceHttpChannelLogger" />
        </int:interceptors>
    </int:channel>
    <int:logging-channel-adapter id="requestServiceHttpChannelLogger" expression="'[Svc][RQ]'+#this" />

    <int-http:outbound-gateway id="httpOutboundGateway" request-channel="requestServiceHttpChannel" reply-channel="responseServiceHttpChannel"
        url-expression="headers.serviceUrl" http-method="POST" expected-response-type="java.lang.String" charset="UTF-8"
        request-factory="httpOutboundRequestFactoryBean" />

    <int:channel id="responseServiceHttpChannel">
        <int:interceptors>
            <int:wire-tap channel="responseServiceHttpChannelLogger" />
        </int:interceptors>
    </int:channel>
    <int:logging-channel-adapter id="responseServiceHttpChannelLogger" expression="'[Svc][RS] '+#this" />

    <int:router id="wsaResponseActionEnricherRouter" input-channel="responseServiceHttpChannel"
        default-output-channel="discardWsaValidatorChannel" ref="wsaActionEnricherRouterBean" method="route">
        <int:mapping value="#{T(gub.msp.bus.routingservice.WSActionEnricherRouter).WSA_ACTION_AVAILABLE}"
            channel="routingServiceHttpOutboundChannel" />
        <int:mapping value="#{T(gub.msp.bus.routingservice.WSActionEnricherRouter).NO_WSA_ACTION}" channel="wsaResponseActionEnricherChannel" />
        <int:mapping value="#{T(gub.msp.bus.routingservice.WSActionEnricherRouter).INTERNAL_ERROR}" channel="discardWsaValidatorChannel" />
    </int:router>

    <int:channel id="wsaResponseActionEnricherChannel" />

    <int:transformer id="wsaResponseActionEnricher" input-channel="wsaResponseActionEnricherChannel"
        output-channel="routingServiceHttpOutboundChannel" ref="wsaActionEnricherBean" />

    <int:channel id="routingServiceHttpOutboundChannel">
        <int:interceptors>
            <int:wire-tap channel="routingServiceHttpOutboundChannelLogger" />
        </int:interceptors>
    </int:channel>
    <int:logging-channel-adapter id="routingServiceHttpOutboundChannelLogger" expression="'[RS] '+#this" />

    <util:map id="defaultNamespaces" map-class="java.util.HashMap">
        <entry key="env" value="#{T(javax.xml.soap.SOAPConstants).URI_NS_SOAP_1_1_ENVELOPE}" />
        <entry key="wsa" value="#{T(gub.msp.bus.routingservice.soap.wsaddressing.AddressingConstants).WSA_NS}" />
    </util:map>
    <int-xml:xpath-expression id="wsaToXPathExpr" expression="${wsaToXpathExpression}"
        namespace-map="defaultNamespaces" />

    <int-xml:xpath-expression id="wsaActionXPathExpr" expression="${wsaActionXpathExpression}"
        namespace-map="defaultNamespaces" />

    <int:exception-type-router input-channel="errorChannel" default-output-channel="internalErrorChannel">
        <int:mapping exception-type="gub.msp.bus.servicecatalog.ServiceNotFoundException" channel="serviceNotFoundChannel" />
        <int:mapping exception-type="org.springframework.web.client.HttpClientErrorException" channel="serviceUnavailableChannel" />
        <int:mapping exception-type="java.net.ConnectException" channel="serviceUnavailableChannel" />
        <int:mapping exception-type="java.net.SocketTimeoutException" channel="serviceTimeoutChannel"/>
    </int:exception-type-router>

    <int:channel id="internalErrorChannel" />
    <int:header-enricher id="internalErrorEnricher" input-channel="internalErrorChannel"
        output-channel="discardWsaValidatorChannel">
        <int:header name="#{T(gub.msp.bus.routingservice.soap.wsaddressing.WSAValidatorConstants).ERROR_HEADER_NAME}"
            value="#{T(gub.msp.bus.routingservice.soap.wsaddressing.WSAValidatorConstants).INTERNAL_SERVER_ERROR }" />
    </int:header-enricher>

    <int:channel id="serviceNotFoundChannel" />
    <int:header-enricher id="serviceNotFoundEnricher" input-channel="serviceNotFoundChannel"
        output-channel="discardWsaValidatorChannel">
        <int:header name="#{T(gub.msp.bus.routingservice.soap.wsaddressing.WSAValidatorConstants).ERROR_HEADER_NAME}"
            value="#{T(gub.msp.bus.routingservice.soap.wsaddressing.WSAValidatorConstants).SERVICE_NOT_FOUND}" />
    </int:header-enricher>

    <int:channel id="serviceUnavailableChannel" />
    <int:header-enricher id="serviceUnavailableEnricher" input-channel="serviceUnavailableChannel"
        output-channel="discardWsaValidatorChannel">
        <int:header name="#{T(gub.msp.bus.routingservice.soap.wsaddressing.WSAValidatorConstants).ERROR_HEADER_NAME}"
            ref="serviceUnavailableEnricherBean" method="enrich" />
    </int:header-enricher>

    <int:channel id="serviceTimeoutChannel"/>
    <int:header-enricher id="serviceTimeoutEnricher" input-channel="serviceTimeoutChannel" output-channel="discardWsaValidatorChannel">
        <int:header name="#{T(gub.msp.bus.routingservice.soap.wsaddressing.WSAValidatorConstants).ERROR_HEADER_NAME}"
            value="#{T(gub.msp.bus.routingservice.soap.wsaddressing.WSAValidatorConstants).SERVICE_TIMEOUT}" />
    </int:header-enricher>
</beans>